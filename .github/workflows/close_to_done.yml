---
name: Auto Update Status to Done

'on':
  issues:
    types: [closed]

jobs:
  update-status:
    runs-on: ubuntu-latest
    steps:
      - name: Set Status to Done (GraphQL)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const user = 'aptmara';
            const projectNumber = 3;
            // 完了とみなすステータス名
            const doneNames = ['Done', '完了', 'Finished', 'Closed'].map(s=>s.toLowerCase());
            
            const issue = context.payload.issue;
            if (!issue) throw new Error('This workflow only runs on issues');

            // User Project 用クエリ
            const fieldsQuery = `
              query($login: String!, $number: Int!) {
                user(login: $login) {
                  projectV2(number: $number) {
                    id
                    fields(first: 50) {
                      nodes {
                        ... on ProjectV2Field { id name dataType }
                        ... on ProjectV2SingleSelectField { id name dataType options { id name } }
                      }
                    }
                  }
                }
              }
            `;

            const pageQuery = `
              query($login: String!, $number: Int!, $first: Int!, $after: String) {
                user(login: $login) {
                  projectV2(number: $number) {
                    items(first: $first, after: $after) {
                      nodes { id content { ... on Issue { id number } } }
                      pageInfo { hasNextPage endCursor }
                    }
                  }
                }
              }
            `;

            const addMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) { item { id } }
              }
            `;

            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: { projectId: $projectId, itemId: $itemId, fieldId: $fieldId, value: { singleSelectOptionId: $optionId } }) { projectV2Item { id } }
              }
            `;

            // 1) Project + fields
            const fieldsRes = await github.graphql(fieldsQuery, { login: user, number: projectNumber });
            const project = fieldsRes.user.projectV2;
            const projectId = project.id;
            
            // "Status" フィールドを探す
            const statusField = project.fields.nodes.find(f =>
              (f.name && (f.name.trim().toLowerCase() === 'status' || f.name.trim() === 'ステータス')) &&
              (f.dataType === 'SINGLE_SELECT')
            );
            if (!statusField) throw new Error('Status (single-select) field not found');
            
            const options = (statusField.options || []).map(o=>({name:o.name,id:o.id}));
            const optIdByName = new Map(options.map(o=>[o.name.trim().toLowerCase(), o.id]));
            
            let doneOptionId = null;
            for (const n of doneNames) { 
              if (optIdByName.has(n)) { 
                doneOptionId = optIdByName.get(n); 
                break; 
              } 
            }
            if (!doneOptionId) {
               console.log('Available options:', options.map(o=>o.name));
               throw new Error('Done option not found in project Status field.');
            }

            // 2) Find item (paged)
            async function findItemId() {
              let after = null;
              while (true) {
                const res = await github.graphql(pageQuery, { login: user, number: projectNumber, first: 100, after });
                const items = res.user.projectV2.items;
                const hit = items.nodes.find(n => n.content && n.content.number === issue.number);
                if (hit) return hit.id;
                if (!items.pageInfo.hasNextPage) return null;
                after = items.pageInfo.endCursor;
              }
            }

            let itemId = await findItemId();
            if (!itemId) {
              // アイテムがない場合は追加してから完了にする
              try {
                const addRes = await github.graphql(addMutation, { projectId, contentId: issue.node_id });
                itemId = addRes.addProjectV2ItemById.item.id;
                console.log('Added item to project:', itemId);
              } catch (e) {
                console.log('Add item failed:', e.message);
              }
              if (!itemId) itemId = await findItemId();
            }
            if (!itemId) throw new Error('Project item for this issue not found and could not be added');

            // 3) Update status to Done
            await github.graphql(updateMutation, { projectId, itemId, fieldId: statusField.id, optionId: doneOptionId });
            console.log('Status set to Done for item', itemId);
